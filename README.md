# ROS2 driver for AcSense

[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](https://opensource.org/licenses/MIT)

This package provides a network driver for the AcSense. Both directed UDP and multicast UDP configurations are available.

**NOTE: ROS 1 version is provided under the `noetic` branch**

## Installation

To build and use the package, call the provided `build_ros_pkg.sh` script from your ROS environment.

## Usage

The following Python `argparse` parameters are available for the publisher node:

- `--use-mcast` : logical flag indicates that the multicast socket configuration shall be used
- `--mcast-group` : sets the value for the UDP multicast group (default: 224.1.1.1)
- `--iface-ip` : sets the IP address of the target interface (on the host computer; default: 192.168.1.115)
- `--port` : sets the port on which to receive the data, for either direct or multicast UDP configuration

The following entry-points are provided for use with ros2 run (example uses multicast UDP argument):

```bash
# Raw Acoustic Data
ros2 run acsense_pubsub publisher --use-mcast
ros2 run acsense_pubsub listener


# Beamformer Data
ros2 run acsense_pubsub beamformer_raw_publisher --use_mcast  #(for mode: raw)
ros2 run acsense_pubsub beamformer_2d_publisher --use_mcast   #(for mode: mean, max)
ros2 run acsense_pubsub beamformer_subscriber

```

## Running in docker

The AcSense ROS modules can be launched within docker containers using the images generated by the provided
`build_docker.sh` script. To start the beamformer publisher, for example, start a container with `--net=host`
to ensure the container can see the data received from the AcSense, and set the appropriate `ROS_DOMAIN_ID` if
necessary.

```bash
docker run -it --rm --net host --name acsense_ros \
    -e ROS_DOMAIN_ID=1 \
    acsense_ros \
    ros2 run acsense_pubsub beamformer_2d_publisher --use_mcast
```

The example beamformer data subscriber can then be launched on the same container, or an independent container
with a matching `ROS_DOMAIN_ID` value.

```bash
# In same container
docker exec -it acsense_ros /ros_entrypoint.sh \
    ros2 run acsense_pubsub beamformer_subscriber

# In separate container
docker run -it --rm --name test \
    -e ROS_DOMAIN_ID=1 \
    acsense_ros \
    ros2 run acsense_pubsub beamformer_subscriber
```

## Visualizing the data stream

The `beamformer_subscriber` provides a basic stream visualization feature,
using `matplotlib`. Though not intended for use in deployment, this feature
provides a simple and convenient mechanism to test and validate the system
during development.

In one terminal screen, launch the publisher:

```bash
# Use Xauthority and DISPLAY passthrough to enable graphics from container
docker run -it --rm --net host --name acsense_ros \
    -e ROS_DOMAIN_ID=1 \
    --volume /run/user/${UID}/gdm/Xauthority:/root/.Xauthority:rw \
    -e DISPLAY=${DISPLAY} \
    acsense_ros \
    ros2 run acsense_pubsub beamformer_2d_publisher --use_mcast
```
In another terminal screen, launch the subscriber with the `--plot` argument:

```bash
# Running in same container as publisher:
docker exec -it acsense_ros /ros_entrypoint.sh \
    ros2 run acsense_pubsub beamformer_subscriber --plot
```

The plot will render the 2D beamformer response, per the bearing & elevation angles
evaluated by the beamformer. The 2D data is also compressed into bearing-only 1D
rasters, which are plotted in an additional waterfall plot to illustrate the response
history over the most recent frames.
